"use strict";var e=require("vscode");function t(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var n={}.toString,i=Array.isArray||function(e){return"[object Array]"==n.call(e)},o=i,s=i,r=function(e){return null!=e&&"object"==typeof e&&!1===o(e)},a=c;function c(e,t){if(!(this instanceof c))return"number"==typeof t?new c(e).fromIndex(t):new c(e,t);this.str=e||"",this.lineToIndex=function(e){for(var t=e.split("\n"),n=new Array(t.length),i=0,o=0,s=t.length;o<s;o++)n[o]=i,i+=t[o].length+1;return n}(this.str),t=t||{},this.origin=void 0===t.origin?1:t.origin}c.prototype.fromIndex=function(e){if(e<0||e>=this.str.length||isNaN(e))return null;var t=function(e,t){if(e>=t[t.length-1])return t.length-1;var n,i=0,o=t.length-2;for(;i<o;)if(e<t[n=i+(o-i>>1)])o=n-1;else{if(!(e>=t[n+1])){i=n;break}i=n+1}return i}(e,this.lineToIndex);return{line:t+this.origin,col:e-this.lineToIndex[t]+this.origin}},c.prototype.toIndex=function(e,t){if(void 0===t)return s(e)&&e.length>=2?this.toIndex(e[0],e[1]):r(e)&&"line"in e&&("col"in e||"column"in e)?this.toIndex(e.line,"col"in e?e.col:e.column):-1;if(isNaN(e)||isNaN(t))return-1;if(e-=this.origin,t-=this.origin,e>=0&&t>=0&&e<this.lineToIndex.length){var n=this.lineToIndex[e];if(t<(e===this.lineToIndex.length-1?this.str.length:this.lineToIndex[e+1])-n)return n+t}return-1};var l=t(a);const g=/([.#])(-?[_a-zA-Z]+[_a-zA-Z0-9-]*)(?=[#.,()\s\[\]\^:*"'>=_a-zA-Z0-9-]*{[^}]*})/g;var u;function f(e){const t=[],n=l(e,{origin:0});let i,o,s,r=0,a=0;for(;i=g.exec(e);)s=i.index,o=n.fromIndex(s),o&&(r=o.line,a=o.col+1),t.push({index:s,line:r,col:a,type:i[1],selector:i[2]});return t}!function(e){e.ID="#",e.CLASS="."}(u||(u={}));const d=new e.Position(0,0),h=new Map,p=/^https?:\/\//i,m=/[_a-zA-Z0-9-]+/,w=/([^(\[{}\])\s]+)(?![^(\[{]*[}\])])/gi,x=/(class|className)\s*[=:]\s*(["'])(.*?)\2/gis,v=/(id|class|className)\s*[=:]\s*(["'])(?:.(?!\2))*$/is;class y{async fetch(t){try{const e=await fetch(t);if(e.ok)return await e.text();throw new Error(e.statusText)}catch(n){e.window.showErrorMessage(`Fetching ${t} failed. ${n}`)}return""}async getRemote(e){let t=h.get(e);if(!t){t=f(await this.fetch(e)),h.set(e,t)}return t}async getLocal(t){const n=t.toString();let i=h.get(n);if(!i){i=f((await e.workspace.fs.readFile(t)).toString()),h.set(n,i)}return i}async getStyles(t){const n=new Map,i=e.workspace.getWorkspaceFolder(t.uri),o=(s=t.uri,e.workspace.getConfiguration("css",s).get("styleSheets",[]));var s;for(const t of o)if(p.test(t))n.set(t,await this.getRemote(t));else if(i){const o=await e.workspace.findFiles(new e.RelativePattern(i,t).pattern);for(const e of o)n.set(e.toString(),await this.getLocal(e))}return n.set(t.uri.toString(),f(t.getText())),n}async getCompletionMap(t,n){const i=new Map,o=await this.getStyles(t);for(const t of o.values())for(const o of t)if(o.type===n){const t=new e.CompletionItem(o.selector,o.type===u.ID?e.CompletionItemKind.Value:e.CompletionItemKind.Enum);i.set(o.selector,t)}return i}async getCompletionItems(e,t,n){const i=await this.getCompletionMap(e,n),o=e.getWordRangeAtPosition(t,m),s=[];for(const e of i.values())e.range=o,s.push(e);return s}provideCompletionItems(t,n,i,o){const s=new e.Range(d,n),r=t.getText(s),a=v.exec(r);return new Promise(((e,o)=>{a&&!i.isCancellationRequested?e(this.getCompletionItems(t,n,"id"===a[1]?u.ID:u.CLASS)):o()}))}async getDefinitions(t,n){const i=await this.getStyles(t),o=t.getWordRangeAtPosition(n,m),s=t.getText(o),r=[];for(const t of i)p.test(t[0])||t[1].filter((e=>e.selector===s)).forEach((n=>r.push(new e.Location(e.Uri.parse(t[0]),new e.Position(n.line,n.col)))));return r}provideDefinition(t,n,i){const o=new e.Range(d,n),s=t.getText(o),r=v.exec(s);return new Promise(((e,o)=>{r&&!i.isCancellationRequested?e(this.getDefinitions(t,n)):o()}))}async validate(t){const n=[],i=await this.getCompletionMap(t,u.CLASS),o=t.getText();let s,r,a,c,l,g;for(;s=x.exec(o);)for(r=x.lastIndex-s[3].length+s[3].indexOf(s[2]);a=w.exec(s[3]);)i.has(a[1])||(c=w.lastIndex+r,l=t.positionAt(c),g=t.positionAt(c-a[1].length),n.push(new e.Diagnostic(new e.Range(g,l),`CSS selector '${a[1]}' not found.`,e.DiagnosticSeverity.Warning)));return n}}exports.activate=function(t){const n=e.workspace.getConfiguration("css").get("enabledLanguages",["html"]),i=e.languages.createDiagnosticCollection(),o=new y;t.subscriptions.push(e.languages.registerCompletionItemProvider(n,o),e.languages.registerDefinitionProvider(n,o),e.workspace.onDidSaveTextDocument((e=>{return t=e.uri.toString(),void h.delete(t);var t})),e.workspace.onDidCloseTextDocument((e=>i.delete(e.uri))),e.workspace.onDidChangeTextDocument((e=>i.delete(e.document.uri))),e.commands.registerCommand("vscode-html-css.validate",(async()=>{const t=e.window.activeTextEditor;if(t){const e=t.document;n.includes(e.languageId)&&i.set(e.uri,await o.validate(e))}})),e.commands.registerCommand("vscode-html-css.clear",(()=>{h.clear()})))},exports.deactivate=function(){};
